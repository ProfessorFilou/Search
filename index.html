<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProfessorFilou's Bot</title>
  <link rel="icon" type="image/jpeg" href="ProfessorFilouLOGO.jpg">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDOp2sOdzZBXcN4znGTd6jqfJXkm9j739o",
      authDomain: "professorfilou-bot.firebaseapp.com",
      databaseURL: "https://professorfilou-bot-default-rtdb.firebaseio.com",
      projectId: "professorfilou-bot",
      storageBucket: "professorfilou-bot.firebasestorage.app",
      messagingSenderId: "945819293412",
      appId: "1:945819293412:web:56268c9a39fa935a877ef1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let myConnectionRef = null;

    let myName = `Gast_${Math.floor(Math.random() * 9000) + 1000}`;
    let myAvatar = "melon.png";

    signInAnonymously(auth).catch(err => console.error("Anon Fehler:", err));

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        myName   = user.displayName || myName;
        myAvatar = user.photoURL   || myAvatar;
        document.getElementById("my-avatar").src = myAvatar;
      }
    });

    const connectedRef   = ref(db, ".info/connected");
    const connectionsRef = ref(db, "connections");

    onValue(connectedRef, snap => {
      if (snap.val() === true && currentUser) {
        myConnectionRef = push(connectionsRef);
        onDisconnect(myConnectionRef).remove();
        set(myConnectionRef, {
          uid: currentUser.uid,
          name: myName,
          avatar: myAvatar,
          connectedAt: serverTimestamp()
        });
      }
    });

    onValue(connectionsRef, snap => {
      const container = document.getElementById("online-users");
      container.innerHTML = "";
      snap.forEach(child => {
        const data = child.val();
        if (!data?.name || !data?.avatar) return;
        const div = document.createElement("div");
        div.className = "online-user";
        const img = document.createElement("img");
        img.src = data.avatar;
        img.alt = data.name;
        const name = document.createElement("span");
        name.textContent = data.name;
        div.appendChild(img);
        div.appendChild(name);
        container.appendChild(div);
      });
    });

    // Profil-MenÃ¼ Funktionen
    window.toggleProfile = () => {
      document.getElementById("profile-menu").classList.toggle("visible");
    };

    window.pickFruit = (src, el) => {
      document.querySelectorAll('.fruit').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
      document.getElementById("preview").src = src;
      window.selectedFruit = src;
    };

    window.saveChanges = () => {
      const name = document.getElementById("name-input").value.trim();
      if (!name || !currentUser) return;
      const avatar = window.selectedFruit || myAvatar;
      updateProfile(currentUser, { displayName: name, photoURL: avatar }).then(() => {
        myName = name;
        myAvatar = avatar;
        document.getElementById("my-avatar").src = avatar;
        if (myConnectionRef) {
          set(myConnectionRef, { uid: currentUser.uid, name, avatar, connectedAt: serverTimestamp() });
        }
        const btn = document.getElementById("save-btn");
        btn.textContent = "âœ“ Gespeichert";
        btn.style.background = "#0f8";
        setTimeout(() => {
          btn.textContent = "Speichern";
          btn.style.background = "";
          document.getElementById("profile-menu").classList.remove("visible");
        }, 1400);
      });
    };

    // Modal Steuerung
    document.addEventListener('DOMContentLoaded', () => {
      const contactBtn = document.getElementById('contact-btn');
      const modal = document.getElementById('contact-modal');
      const closeBtn = document.querySelector('.close-modal');

      if (contactBtn) contactBtn.onclick = () => modal.style.display = 'flex';
      if (closeBtn) closeBtn.onclick = () => modal.style.display = 'none';
      window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };
    });
  </script>

  <style>
    :root {
      --bg: #0a0a0a;
      --chat-bg: #111111;
      --user: #ffffff;
      --user-text: #0d1117;
      --bot: #1e1e1e;
      --text: #e9ecef;
      --border: #222222;
      --send-bg: #ffffff;
      --send-text: #0d1117;
      --send-hover: #e0e0e0;
      --glow-color1: rgba(255, 0, 0, 0.6);
      --glow-color2: rgba(0, 255, 0, 0.6);
      --glow-color3: rgba(0, 0, 255, 0.6);
      --glow-color4: rgba(255, 165, 0, 0.6);
      --glow-color5: rgba(255, 255, 0, 0.6);
      --accent: #44ff88;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at bottom, #0a001f 0%, #000 100%);
      z-index: -2;
      pointer-events: none;
    }

    .stars { position: fixed; inset: 0; background: transparent; z-index: -1; pointer-events: none; }
    .star  { position: absolute; background: white; border-radius: 50%; opacity: 0.6; animation: twinkle 6s infinite alternate, drift 120s linear infinite; }

    @keyframes twinkle { 0% { opacity: 0.3 } 100% { opacity: 0.9 } }
    @keyframes drift    { 0% { transform: translateX(-10vw) translateY(-10vh) } 100% { transform: translateX(110vw) translateY(110vh) } }

    header {
      background: rgba(13,17,23,0.85);
      backdrop-filter: blur(8px);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #222;
      position: sticky;
      top: 0;
      z-index: 10;
      flex-wrap: wrap;
      gap: 12px;
    }

    .logo { width: 44px; height: 44px; border-radius: 10px; object-fit: cover; }

    .header-text { flex: 1; min-width: 0; }
    h1 { margin: 0; font-size: 1.35rem; font-weight: 600; }

    #live-info { font-size: 0.95rem; color: #aaa; display: flex; align-items: center; gap: 8px; white-space: nowrap; }

    #header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    #my-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #444;
      cursor: pointer;
      transition: all 0.2s;
    }

    #my-avatar:hover {
      transform: scale(1.08);
      box-shadow: 0 0 12px rgba(68,255,136,0.5);
    }

    #online-users {
      display: flex;
      gap: 8px;
      align-items: center;
      max-width: 180px;
      overflow-x: auto;
      padding: 4px 0;
    }

    .online-user {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 40px;
      text-align: center;
    }

    .online-user img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 1.5px solid #333;
    }

    .online-user span {
      font-size: 0.68rem;
      color: #aaa;
      margin-top: 2px;
      max-width: 44px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #profile-menu {
      position: absolute;
      top: 70px;
      right: 16px;
      background: rgba(18,18,24,0.96);
      backdrop-filter: blur(10px);
      border: 1px solid #333;
      border-radius: 14px;
      padding: 16px;
      width: 260px;
      max-width: 90vw;
      box-shadow: 0 8px 28px rgba(0,0,0,0.7);
      display: none;
      z-index: 100;
    }

    #profile-menu.visible { display: block; }

    .fruit-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 12px 0;
    }

    .fruit {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.18s;
    }

    .fruit:hover, .fruit.active {
      border-color: var(--accent);
      transform: scale(1.1);
      box-shadow: 0 0 14px rgba(68,255,136,0.5);
    }

    #preview {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: block;
      margin: 0 auto 12px;
      border: 3px solid var(--accent);
    }

    #name-input {
      width: 100%;
      padding: 10px 14px;
      background: #181818;
      border: 1px solid #444;
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      margin-bottom: 12px;
    }

    #save-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #33cc77, #0f8);
      color: #000;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    #chat {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 90%;
      padding: 14px 18px;
      border-radius: 20px;
      line-height: 1.6;
      font-size: 1.05rem;
      word-wrap: break-word;
      position: relative;
      overflow: hidden;
    }

    .user   { background: var(--user);   align-self: flex-end; color: var(--user-text); }
    .bot    { background: var(--bot);    align-self: flex-start; color: var(--text); border: 1px solid #2a2a2a; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

    .bot::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(transparent, var(--glow-color1), var(--glow-color2), var(--glow-color3), var(--glow-color4), var(--glow-color5), transparent);
      filter: blur(25px);
      opacity: 0.6;
      animation: glow-rotate 12s linear infinite;
      transform-origin: center;
    }

    @keyframes glow-rotate { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }

    #input-area {
      padding: 16px;
      background: var(--chat-bg);
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      z-index: 10;
    }

    #input {
      flex: 1 1 220px;
      min-width: 180px;
      padding: 14px 18px;
      border: 1px solid var(--border);
      border-radius: 30px;
      background: #181818;
      color: white;
      outline: none;
      font-size: 1.05rem;
    }

    #send, #contact-btn {
      padding: 0 20px;
      height: 48px;
      background: var(--send-bg);
      color: var(--send-text);
      border: none;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    #send:hover { background: var(--send-hover); }

    #contact-btn {
      background: linear-gradient(135deg, #444, #222);
      color: #e0e0e0;
      border: 1px solid #444;
    }

    #contact-btn:hover {
      background: linear-gradient(135deg, var(--accent), #0c6);
      color: #000;
      box-shadow: 0 0 16px rgba(68,255,136,0.5);
    }

    footer {
      text-align: center;
      padding: 20px 0;
      color: #666;
      font-size: 0.85rem;
      border-top: 1px solid #1e1e1e;
      margin-top: auto;
    }

    .typing {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      align-self: flex-start;
      position: relative;
      width: 80px;
      height: 80px;
    }

    .loader-logo {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      object-fit: cover;
      z-index: 2;
    }

    .loader-glow {
      position: absolute;
      inset: -20%;
      background: conic-gradient(transparent, var(--glow-color1), var(--glow-color2), var(--glow-color3), var(--glow-color4), var(--glow-color5), transparent);
      filter: blur(20px);
      opacity: 0.7;
      animation: glow-rotate 8s linear infinite;
      border-radius: 50%;
    }

    /* Kontakt Modal â€“ responsive & passend zum Stil */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal-content {
      background: rgba(20,20,25,0.96);
      backdrop-filter: blur(12px);
      border: 1px solid #333;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 460px;
      position: relative;
      box-shadow: 0 12px 40px rgba(0,0,0,0.7);
    }

    .close-modal {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 32px;
      color: #888;
      cursor: pointer;
      line-height: 1;
    }

    .close-modal:hover { color: #ff5555; }

    .modal-content h2 {
      margin: 0 0 20px;
      text-align: center;
      color: #ccc;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      background: #181818;
      border: 1px solid #444;
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      resize: vertical;
    }

    .modal-content textarea {
      min-height: 110px;
    }

    .modal-content button[type="submit"] {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--accent), #0c6);
      color: #000;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.05rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-content button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(68,255,136,0.5);
    }

    /* Responsive Anpassungen */
    @media (max-width: 480px) {
      header { flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; }
      #header-right { width: 100%; justify-content: flex-end; }
      #online-users { max-width: 140px; }
      .online-user img { width: 24px; height: 24px; }
      .online-user span { font-size: 0.65rem; }
      #input-area { flex-direction: column; align-items: stretch; }
      #input { width: 100%; }
      #send, #contact-btn { width: 100%; }
      #profile-menu { right: 8px; width: calc(100% - 16px); }
    }

    @media (max-width: 360px) {
      h1 { font-size: 1.2rem; }
      #my-avatar { width: 38px; height: 38px; }
    }
  </style>
</head>
<body>

<div class="stars" id="stars"></div>

<header>
  <img src="ProfessorFilouLOGO.jpg" alt="Logo" class="logo">
  <div class="header-text">
    <h1>ProfessorFilou's Bot</h1>
    <div id="live-info"><span id="weather-icon">â›…</span> <span id="live-time"></span></div>
  </div>

  <div id="header-right">
    <div id="online-users"></div>
    <img id="my-avatar" src="melon.png" alt="Mein Avatar" onclick="toggleProfile()">
  </div>

  <div id="profile-menu">
    <h3 style="margin:0 0 12px;text-align:center;color:#ccc;">Mein Profil</h3>
    <img id="preview" src="melon.png" alt="Vorschau">
    <div class="fruit-grid">
      <img class="fruit" src="apple.png"   onclick="pickFruit(this.src, this)">
      <img class="fruit" src="ice.png"     onclick="pickFruit(this.src, this)">
      <img class="fruit" src="kiwi.png"    onclick="pickFruit(this.src, this)">
      <img class="fruit" src="orange.png"  onclick="pickFruit(this.src, this)">
      <img class="fruit" src="melon.png"   onclick="pickFruit(this.src, this)">
      <img class="fruit" src="avocado.png" onclick="pickFruit(this.src, this)">
    </div>
    <input id="name-input" type="text" placeholder="Dein Name">
    <button id="save-btn" onclick="saveChanges()">Speichern</button>
  </div>
</header>

<div id="chat"></div>

<div id="input-area">
  <input id="input" placeholder="Frag mich â€¦ oder rechne 5+3*2" autocomplete="off"/>
  <button id="send">Senden</button>
  <button id="contact-btn">Kontakt</button>
</div>

<!-- Kontakt Modal -->
<div id="contact-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal">Ã—</span>
    <h2>Kontakt</h2>
    <form action="https://formspree.io/f/xjgeywev" method="POST">
      <input type="text"     name="name"    placeholder="Dein Name" required>
      <input type="email"    name="email"   placeholder="Deine E-Mail" required>
      <textarea name="message" placeholder="Deine Nachricht" rows="5" required></textarea>
      <input type="hidden"   name="_subject" value="Neue Nachricht vom ProfessorFilou Bot">
      <button type="submit">Absenden</button>
    </form>
  </div>
</div>

<footer>
  Â© ProfessorFilou
</footer>

<script>
// â”€â”€â”€ DEIN ORIGINAL BOT-CODE â”€â”€â”€ (unverÃ¤ndert)

function createStars() {
  const starsContainer = document.getElementById('stars');
  for (let i = 0; i < 120; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    const size = Math.random() * 2 + 0.5;
    star.style.width = star.style.height = size + 'px';
    star.style.left = Math.random() * 100 + 'vw';
    star.style.top = Math.random() * 100 + 'vh';
    star.style.animationDelay = Math.random() * 6 + 's';
    star.style.animationDuration = (Math.random() * 80 + 80) + 's';
    starsContainer.appendChild(star);
  }
}
createStars();

async function updateTimeAndWeather() {
  const now = new Date();
  const options = {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  };
  document.getElementById('live-time').textContent = now.toLocaleString('de-DE', options);
  try {
    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=48.1351&longitude=11.5820&current_weather=true');
    const data = await res.json();
    const code = data.current_weather.weathercode;
    const temp = Math.round(data.current_weather.temperature);
    let icon = 'â›…';
    if (code <= 3) icon = 'â˜€ï¸';
    else if (code <= 12) icon = 'â˜ï¸';
    else if (code <= 49) icon = 'ðŸŒ§ï¸';
    else if (code <= 67) icon = 'ðŸŒ¨ï¸';
    else if (code <= 99) icon = 'â›ˆï¸';
    document.getElementById('weather-icon').textContent = `${icon} ${temp}Â°C`;
  } catch {
    document.getElementById('weather-icon').textContent = 'â›…';
  }
}
setInterval(updateTimeAndWeather, 1000);
updateTimeAndWeather();

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

function addMessage(content, isUser = false) {
  const div = document.createElement('div');
  div.className = `message ${isUser ? 'user' : 'bot'}`;
  div.innerHTML = content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function showTyping() {
  const t = document.createElement('div');
  t.className = 'typing';
  t.innerHTML = `
    <div class="loader-glow"></div>
    <img src="ProfessorFilouLOGO.jpg" alt="Loading" class="loader-logo">
  `;
  t.id = 'typing';
  chat.appendChild(t);
  chat.scrollTop = chat.scrollHeight;
  return t;
}

async function streamText(el, text, speed = 22) {
  el.innerHTML = '';
  const words = text.split(' ');
  for (let w of words) {
    el.innerHTML += w + ' ';
    chat.scrollTop = chat.scrollHeight;
    await new Promise(r => setTimeout(r, speed + Math.random() * 28));
  }
}

function calculate(expr) {
  try {
    let cleaned = expr
      .replace(/\s+/g, '')
      .replace(/,/g, '.')
      .replace(/:/g, '/')
      .replace(/x/gi, '*');
    if (!/^[0-9+\-*/^().sqrt]+$/.test(cleaned)) return null;
    cleaned = cleaned
      .replace(/\^/g, '**')
      .replace(/sqrt\(/g, 'Math.sqrt(');
    const result = eval(cleaned);
    return isNaN(result) || !isFinite(result) ? null : result;
  } catch {
    return null;
  }
}

async function getWikiSummary(query) {
  try {
    let searchUrl = `https://de.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&utf8=&format=json&origin=*`;
    let res = await fetch(searchUrl);
    let data = await res.json();
    if (!data.query?.search?.length) {
      return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
    }
    const title = data.query.search[0].title;
    const pageUrl = `https://de.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&exsentences=5&format=json&titles=${encodeURIComponent(title)}&origin=*`;
    res = await fetch(pageUrl);
    data = await res.json();
    const pages = data.query.pages;
    const pageId = Object.keys(pages)[0];
    if (pageId === '-1') {
      return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
    }
    const extract = pages[pageId].extract;
    if (!extract || extract.trim().length < 20 || extract.includes('steht fÃ¼r')) {
      return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
    }
    const cleanExtract = extract.split('\n')[0].trim();
    return `<strong>${title}</strong><br><br>${cleanExtract}<br><br><small>Quelle: Wikipedia â€¢ ${new Date().toLocaleString('de-DE')}</small>`;
  } catch (e) {
    return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
  }
}

async function handleSend() {
  let q = input.value.trim();
  if (!q) return;
  addMessage(q, true);
  input.value = '';
  let answer = '';
  const calcRegex = /^[\d+\-*/x:.()^sqrt ]+$/i;
  if (calcRegex.test(q) || q.toLowerCase().startsWith('rechne ')) {
    const expr = q.replace(/^rechne\s+/i, '').trim();
    const result = calculate(expr);
    if (result !== null) {
      answer = `Ergebnis:<br><strong>${result}</strong>`;
    } else {
      answer = 'Konnte nicht rechnen. Beispiel: 5+3*2 144 sqrt 3:8 2x5 10-4/2';
    }
  } else {
    const typing = showTyping();
    await new Promise(r => setTimeout(r, 1800 + Math.random() * 3000));
    answer = await getWikiSummary(q);
    typing.remove();
  }
  const msg = addMessage('', false);
  await streamText(msg, answer);
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keypress', e => {
  if (e.key === 'Enter') handleSend();
});

addMessage('Hey! Ich bin dein ProfessorFilou-Bot. Frag mich doch einfach Sachen, dann such ich im Internet danach oder gib mir eine Matheaufgabe wie 2 + 5 oder schwieriger.', false);
</script>

</body>
</html>