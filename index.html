<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProfessorFilou's Bot</title>
  <link rel="icon" type="image/jpeg" href="ProfessorFilouLOGO.jpg">

  <!-- Firebase SDK (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDOp2sOdzZBXcN4znGTd6jqfJXkm9j739o",
      authDomain: "professorfilou-bot.firebaseapp.com",
      databaseURL: "https://professorfilou-bot-default-rtdb.firebaseio.com",
      projectId: "professorfilou-bot",
      storageBucket: "professorfilou-bot.firebasestorage.app",
      messagingSenderId: "945819293412",
      appId: "1:945819293412:web:56268c9a39fa935a877ef1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Profil & Avatare
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const fruitAvatars = [
      "apple.png",
      "ice.png",
      "kiwi.png",
      "orange.png",
      "melon.png",
      "avocado.png"
    ];

    let currentUser = null;
    let myConnectionRef = null;
    let myName = `Gast_${Math.floor(Math.random()*9000)+1000}`;
    let myAvatar = "melon.png"; // Start mit Melone â€“ wird spÃ¤ter Ã¼berschrieben

    signInAnonymously(auth).catch(err => console.error("Anon Fehler:", err));

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        myName   = user.displayName || myName;
        myAvatar = user.photoURL   || myAvatar;

        document.getElementById("my-avatar").src = myAvatar;
        document.getElementById("name-input").value = myName;
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Presence â€“ wer ist online
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const connectedRef   = ref(db, ".info/connected");
    const connectionsRef = ref(db, "connections");

    onValue(connectedRef, snap => {
      if (snap.val() === true && currentUser) {
        myConnectionRef = push(connectionsRef);
        onDisconnect(myConnectionRef).remove();

        set(myConnectionRef, {
          uid: currentUser.uid,
          name: myName,
          avatar: myAvatar,
          connectedAt: serverTimestamp()
        });
      }
    });

    // Kompakte Online-Anzeige
    onValue(connectionsRef, snap => {
      const container = document.getElementById("online-users");
      container.innerHTML = "";

      snap.forEach(child => {
        const data = child.val();
        if (!data?.name || !data?.avatar) return;

        const item = document.createElement("div");
        item.className = "online-user";

        const img = document.createElement("img");
        img.src = data.avatar;
        img.alt = data.name;
        img.title = data.name;

        const name = document.createElement("div");
        name.textContent = data.name;

        item.appendChild(img);
        item.appendChild(name);
        container.appendChild(item);
      });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Profil-MenÃ¼ Funktionen
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.toggleProfileMenu = function() {
      document.getElementById("profile-menu").classList.toggle("visible");
    };

    window.selectFruit = function(src, elem) {
      document.querySelectorAll('.fruit-option').forEach(e => e.classList.remove('selected'));
      elem.classList.add('selected');
      document.getElementById("preview-fruit").src = src;
      window.selectedFruit = src;
    };

    window.saveProfile = function() {
      const name = document.getElementById("name-input").value.trim();
      if (!name || !currentUser) return;

      const avatar = window.selectedFruit || myAvatar;

      updateProfile(currentUser, {
        displayName: name,
        photoURL: avatar
      }).then(() => {
        myName   = name;
        myAvatar = avatar;

        document.getElementById("my-avatar").src = avatar;

        if (myConnectionRef) {
          set(myConnectionRef, {
            uid: currentUser.uid,
            name: name,
            avatar: avatar,
            connectedAt: serverTimestamp()
          });
        }

        // Erfolgs-Animation
        const btn = document.getElementById("save-btn");
        btn.innerHTML = "Gespeichert âœ“";
        btn.style.background = "linear-gradient(135deg, #44ff88, #22cc66)";
        btn.style.boxShadow = "0 0 20px rgba(68,255,136,0.7)";

        setTimeout(() => {
          btn.innerHTML = "Speichern";
          btn.style.background = "";
          btn.style.boxShadow = "";
          document.getElementById("profile-menu").classList.remove("visible");
        }, 1600);
      });
    };
  </script>

  <style>
    :root {
      --bg: #0a0a0a;
      --chat-bg: #111111;
      --user: #ffffff;
      --user-text: #0d1117;
      --bot: #1e1e1e;
      --text: #e9ecef;
      --border: #222222;
      --send-bg: #ffffff;
      --send-text: #0d1117;
      --send-hover: #e0e0e0;
      --glow-color1: rgba(255, 0, 0, 0.6);
      --glow-color2: rgba(0, 255, 0, 0.6);
      --glow-color3: rgba(0, 0, 255, 0.6);
      --glow-color4: rgba(255, 165, 0, 0.6);
      --glow-color5: rgba(255, 255, 0, 0.6);
      --accent: #44ff88;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* Dein kompletter Original-Style bleibt erhalten   */
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,sans-serif; min-height:100vh; display:flex; flex-direction:column; position:relative; overflow-x:hidden; }
    body::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at bottom, #0a001f 0%, #000 100%); z-index:-2; pointer-events:none; }
    .stars {position:fixed;inset:0;background:transparent;z-index:-1;pointer-events:none;}
    .star {position:absolute;background:white;border-radius:50%;opacity:0.6;animation:twinkle 6s infinite alternate, drift 120s linear infinite;}
    @keyframes twinkle{0%{opacity:0.3}100%{opacity:0.9}}
    @keyframes drift{0%{transform:translateX(-10vw) translateY(-10vh)}100%{transform:translateX(110vw) translateY(110vh)}}

    header {
      background:rgba(13,17,23,0.85);
      backdrop-filter:blur(8px);
      padding:10px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid #222;
      position:sticky;
      top:0;
      z-index:10;
    }

    .logo {width:44px;height:44px;border-radius:10px;object-fit:cover;}

    h1 {margin:0;font-size:1.35rem;font-weight:600;}

    #profile-area {
      display:flex;
      flex-direction:column;
      align-items:center;
      cursor:pointer;
    }

    #my-avatar {
      width:42px;
      height:42px;
      border-radius:50%;
      object-fit:contain;
      border:2px solid #444;
      box-shadow:0 0 12px rgba(100,255,180,0.5);
      transition:all 0.2s;
    }

    #my-avatar:hover {
      transform:scale(1.1);
      box-shadow:0 0 20px rgba(100,255,180,0.8);
    }

    /* Profil-MenÃ¼ */
    #profile-menu {
      position:absolute;
      top:70px;
      right:16px;
      background:rgba(20,20,25,0.92);
      backdrop-filter:blur(10px);
      border:1px solid #333;
      border-radius:16px;
      padding:18px;
      width:300px;
      max-width:90vw;
      box-shadow:0 10px 35px rgba(0,0,0,0.7);
      display:none;
      z-index:100;
    }

    #profile-menu.visible { display:block; }

    .fruit-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin:16px 0 20px;
    }

    .fruit-option {
      width:68px;
      height:68px;
      border-radius:50%;
      object-fit:contain;
      cursor:pointer;
      border:3px solid transparent;
      transition:all 0.18s;
      background:rgba(255,255,255,0.05);
    }

    .fruit-option:hover,
    .fruit-option.selected {
      border-color:var(--accent);
      transform:scale(1.12);
      box-shadow:0 0 20px rgba(68,255,136,0.6);
    }

    #preview-fruit {
      width:90px;
      height:90px;
      border-radius:50%;
      display:block;
      margin:0 auto 16px;
      border:3px solid var(--accent);
      box-shadow:0 0 25px rgba(68,255,136,0.5);
      background:#111;
    }

    #name-input {
      width:100%;
      padding:10px 14px;
      margin-bottom:16px;
      background:#181818;
      border:1px solid #333;
      border-radius:10px;
      color:white;
      font-size:1rem;
      outline:none;
    }

    #name-input:focus {
      border-color:var(--accent);
      box-shadow:0 0 12px rgba(68,255,136,0.4);
    }

    #save-btn {
      width:100%;
      padding:12px;
      background:linear-gradient(135deg, #44ff88, #22cc66);
      color:#000;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
    }

    #save-btn:hover {
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(68,255,136,0.5);
    }

    /* Kompakte Online-Liste */
    #online-users {
      display:flex;
      flex-wrap:wrap;
      gap:14px 10px;
      justify-content:flex-end;
      padding:8px 0;
      background:rgba(0,0,0,0.2);
      border-bottom:1px solid #222;
    }

    .online-user {
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:48px;
      text-align:center;
    }

    .online-user img {
      width:38px;
      height:38px;
      border-radius:50%;
      object-fit:contain;
      border:2px solid #333;
      margin-bottom:3px;
      box-shadow:0 0 10px rgba(100,255,180,0.3);
    }

    .online-user div {
      font-size:0.75rem;
      color:#aaa;
      max-width:50px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Rest deines Original-Styles (chat, messages, input-area, typing, glow usw.) bleibt 1:1 gleich */
    #chat {flex:1 1 auto;overflow-y:auto;padding:20px 16px;display:flex;flex-direction:column;gap:16px;min-height:0;-webkit-overflow-scrolling:touch;}
    .message {max-width:90%;padding:14px 18px;border-radius:20px;line-height:1.6;font-size:1.05rem;word-wrap:break-word;position:relative;overflow:hidden;}
    .user {background:var(--user);align-self:flex-end;color:var(--user-text);}
    .bot {background:var(--bot);align-self:flex-start;color:var(--text);border:1px solid #2a2a2a;box-shadow:0 0 20px rgba(0,0,0,0.5);}
    .bot::before {content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(transparent,var(--glow-color1),var(--glow-color2),var(--glow-color3),var(--glow-color4),var(--glow-color5),transparent);filter:blur(25px);opacity:0.6;animation:glow-rotate 12s linear infinite;transform-origin:center;}
    @keyframes glow-rotate {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    #input-area {padding:16px;background:var(--chat-bg);border-top:1px solid var(--border);display:flex;gap:12px;align-items:center;z-index:10;}
    #input {flex:1;padding:14px 18px;border:1px solid var(--border);border-radius:30px;background:#181818;color:white;outline:none;font-size:1.05rem;}
    #send {padding:0 28px;background:var(--send-bg);color:var(--send-text);border:none;border-radius:30px;font-weight:600;cursor:pointer;transition:all 0.2s;height:48px;display:flex;align-items:center;justify-content:center;}
    #send:hover {background:var(--send-hover);}
    footer {text-align:center;padding:20px 0;color:#666;font-size:0.85rem;border-top:1px solid #1e1e1e;margin-top:auto;}
    .typing {display:flex;justify-content:center;align-items:center;padding:20px;align-self:flex-start;position:relative;width:80px;height:80px;}
    .loader-logo {width:50px;height:50px;border-radius:12px;object-fit:cover;z-index:2;}
    .loader-glow {position:absolute;inset:-20%;background:conic-gradient(transparent,var(--glow-color1),var(--glow-color2),var(--glow-color3),var(--glow-color4),var(--glow-color5),transparent);filter:blur(20px);opacity:0.7;animation:glow-rotate 8s linear infinite;border-radius:50%;}
  </style>
</head>
<body>

<div class="stars" id="stars"></div>

<header>
  <img src="ProfessorFilouLOGO.jpg" alt="Logo" class="logo">
  <div class="header-text">
    <h1>ProfessorFilou's Bot</h1>
    <div id="live-info"><span id="weather-icon">â›…</span> <span id="live-time"></span></div>
  </div>

  <div id="profile-area" onclick="toggleProfileMenu()">
    <img id="my-avatar" src="melon.png" alt="Dein Avatar">
  </div>

  <div id="profile-menu">
    <h3 style="margin:0 0 14px;text-align:center;color:#ccc;">Mein Profil</h3>

    <img id="preview-fruit" src="melon.png" alt="Vorschau">

    <div class="fruit-grid">
      <img class="fruit-option" src="apple.png"    onclick="selectFruit(this.src, this)">
      <img class="fruit-option" src="ice.png"      onclick="selectFruit(this.src, this)">
      <img class="fruit-option" src="kiwi.png"     onclick="selectFruit(this.src, this)">
      <img class="fruit-option" src="orange.png"   onclick="selectFruit(this.src, this)">
      <img class="fruit-option" src="melon.png"    onclick="selectFruit(this.src, this)">
      <img class="fruit-option" src="avocado.png"  onclick="selectFruit(this.src, this)">
    </div>

    <input id="name-input" type="text" placeholder="Dein Name">

    <button id="save-btn" onclick="saveProfile()">Speichern</button>
  </div>
</header>

<div id="online-users"></div>

<div id="chat"></div>

<div id="input-area">
  <input id="input" placeholder="Frag mich â€¦ oder rechne 5+3*2" autocomplete="off"/>
  <button id="send">Senden</button>
</div>

<footer>
  Â© ProfessorFilou
</footer>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DEIN ORIGINAL JAVASCRIPT â€“ 1:1 unverÃ¤ndert
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createStars() {
  const starsContainer = document.getElementById('stars');
  for (let i = 0; i < 120; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    const size = Math.random() * 2 + 0.5;
    star.style.width = star.style.height = size + 'px';
    star.style.left = Math.random() * 100 + 'vw';
    star.style.top = Math.random() * 100 + 'vh';
    star.style.animationDelay = Math.random() * 6 + 's';
    star.style.animationDuration = (Math.random() * 80 + 80) + 's';
    starsContainer.appendChild(star);
  }
}
createStars();

async function updateTimeAndWeather() {
  const now = new Date();
  const options = {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  };
  document.getElementById('live-time').textContent = now.toLocaleString('de-DE', options);
  try {
    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=48.1351&longitude=11.5820&current_weather=true');
    const data = await res.json();
    const code = data.current_weather.weathercode;
    const temp = Math.round(data.current_weather.temperature);
    let icon = 'â›…';
    if (code <= 3) icon = 'â˜€ï¸';
    else if (code <= 12) icon = 'â˜ï¸';
    else if (code <= 49) icon = 'ðŸŒ§ï¸';
    else if (code <= 67) icon = 'ðŸŒ¨ï¸';
    else if (code <= 99) icon = 'â›ˆï¸';
    document.getElementById('weather-icon').textContent = `${icon} ${temp}Â°C`;
  } catch {
    document.getElementById('weather-icon').textContent = 'â›…';
  }
}
setInterval(updateTimeAndWeather, 1000);
updateTimeAndWeather();

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

function addMessage(content, isUser = false) {
  const div = document.createElement('div');
  div.className = `message ${isUser ? 'user' : 'bot'}`;
  div.innerHTML = content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function showTyping() {
  const t = document.createElement('div');
  t.className = 'typing';
  t.innerHTML = `
    <div class="loader-glow"></div>
    <img src="ProfessorFilouLOGO.jpg" alt="Loading" class="loader-logo">
  `;
  t.id = 'typing';
  chat.appendChild(t);
  chat.scrollTop = chat.scrollHeight;
  return t;
}

async function streamText(el, text, speed = 22) {
  el.innerHTML = '';
  const words = text.split(' ');
  for (let w of words) {
    el.innerHTML += w + ' ';
    chat.scrollTop = chat.scrollHeight;
    await new Promise(r => setTimeout(r, speed + Math.random() * 28));
  }
}

function calculate(expr) {
  try {
    let cleaned = expr
      .replace(/\s+/g, '')
      .replace(/,/g, '.')
      .replace(/:/g, '/')
      .replace(/x/gi, '*');
    if (!/^[0-9+\-*/^().sqrt]+$/.test(cleaned)) return null;
    cleaned = cleaned
      .replace(/\^/g, '**')
      .replace(/sqrt\(/g, 'Math.sqrt(');
    const result = eval(cleaned);
    return isNaN(result) || !isFinite(result) ? null : result;
  } catch {
    return null;
  }
}

async function getWikiSummary(query) {
  try {
    let searchUrl = `https://de.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&utf8=&format=json&origin=*`;
    let res = await fetch(searchUrl);
    let data = await res.json();
    if (!data.query?.search?.length) {
      return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
    }
    const title = data.query.search[0].title;
    const pageUrl = `https://de.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&exsentences=5&format=json&titles=${encodeURIComponent(title)}&origin=*`;
    res = await fetch(pageUrl);
    data = await res.json();
    const pages = data.query.pages;
    const pageId = Object.keys(pages)[0];
    if (pageId === '-1') {
      return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
    }
    const extract = pages[pageId].extract;
    if (!extract || extract.trim().length < 20 || extract.includes('steht fÃ¼r')) {
      return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
    }
    const cleanExtract = extract.split('\n')[0].trim();
    return `<strong>${title}</strong><br><br>${cleanExtract}<br><br><small>Quelle: Wikipedia â€¢ ${new Date().toLocaleString('de-DE')}</small>`;
  } catch (e) {
    return `Zu â€ž${query}â€œ gibt es keine gute Zusammenfassung.`;
  }
}

async function handleSend() {
  let q = input.value.trim();
  if (!q) return;
  addMessage(q, true);
  input.value = '';
  let answer = '';
  const calcRegex = /^[\d+\-*/x:.()^sqrt ]+$/i;
  if (calcRegex.test(q) || q.toLowerCase().startsWith('rechne ')) {
    const expr = q.replace(/^rechne\s+/i, '').trim();
    const result = calculate(expr);
    if (result !== null) {
      answer = `Ergebnis:<br><strong>${result}</strong>`;
    } else {
      answer = 'Konnte nicht rechnen. Beispiel: 5+3*2 144 sqrt 3:8 2x5 10-4/2';
    }
  } else {
    const typing = showTyping();
    await new Promise(r => setTimeout(r, 1800 + Math.random() * 3000));
    answer = await getWikiSummary(q);
    typing.remove();
  }
  const msg = addMessage('', false);
  await streamText(msg, answer);
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keypress', e => {
  if (e.key === 'Enter') handleSend();
});

addMessage('Hey! Ich bin dein ProfessorFilou-Bot. Frag mich doch einfach Sachen, dann such ich im Internet danach oder gib mir eine Matheaufgabe wie 2 + 5 oder schwieriger.', false);
</script>

</body>
</html>